<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho - DesignFej</title>
    <link rel="stylesheet" href="/css/carrinho.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <button onclick="window.location.href='index.html'" class="icon-btn">üè° In√≠cio</button>
        <h1>DesignFej</h1>
    </header>

    <div class="carrinho-container">
        <h2>Meu Carrinho</h2>
        
        <div id="carrinho-vazio" class="carrinho-vazio" style="display: none;">
            <i class="fas fa-shopping-cart"></i>
            <p>Seu carrinho est√° vazio</p>
            <a href="index.html" class="btn-voltar">Voltar √†s compras</a>
        </div>
        
        <div id="carrinho-itens">
            <!-- Itens do carrinho ser√£o inseridos aqui via JavaScript -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const carrinhoItens = JSON.parse(localStorage.getItem('designfej_cart')) || [];
            const carrinhoVazio = document.getElementById('carrinho-vazio');
            const carrinhoItensContainer = document.getElementById('carrinho-itens');
            
            if (carrinhoItens.length === 0) {
                carrinhoVazio.style.display = 'block';
                carrinhoItensContainer.innerHTML = '';
                return;
            }
            
            carrinhoVazio.style.display = 'none';
            
            let html = '';
            let total = 0;
            
            // Criar HTML para cada item do carrinho
            carrinhoItens.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                html += `
                    <div class="carrinho-item">
                        <div class="item-imagem">${item.name}</div>
                        <div class="item-info">
                            <div class="item-nome">${item.name}</div>
                            <div class="item-detalhes">${item.details}</div>
                            <div class="item-preco">R$ ${item.price.toFixed(2)}</div>
                            <div class="item-quantidade">
                                <button class="quantidade-btn" onclick="alterarQuantidade(${index}, -1)">-</button>
                                <input type="text" class="quantidade-input" value="${item.quantity}" readonly>
                                <button class="quantidade-btn" onclick="alterarQuantidade(${index}, 1)">+</button>
                            </div>
                        </div>
                        <button class="remover-item" onclick="removerItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            // Adicionar resumo do carrinho
            html += `
                <div class="carrinho-resumo">
                    <div class="resumo-titulo">Resumo do Pedido</div>
                    ${carrinhoItens.map((item, index) => `
                        <div class="resumo-linha">
                            <span>${item.name} (${item.quantity}x)</span>
                            <span>R$ ${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    
                    <div class="cupom-section">
                        <div class="cupom-titulo">Cupom de Desconto</div>
                        <div class="cupom-input-group">
                            <input type="text" id="cupom-codigo" placeholder="Digite o c√≥digo do cupom" maxlength="20">
                            <button onclick="aplicarCupom()" id="btn-aplicar">Aplicar</button>
                            <button onclick="removerCupom()" id="btn-remover" style="display: none;">Remover</button>
                        </div>
                        <div id="cupom-resultado"></div>
                    </div>
                    
                    <div class="resumo-subtotal">
                        <span>Subtotal:</span>
                        <span id="subtotal">R$ ${total.toFixed(2)}</span>
                    </div>
                    <div id="desconto-linha" style="display: none;">
                        <span>Desconto:</span>
                        <span id="desconto-valor">R$ 0,00</span>
                    </div>
                    <div class="resumo-total">
                        <span>Total:</span>
                        <span id="total-final">R$ ${total.toFixed(2)}</span>
                    </div>
                    <button class="btn-finalizar" onclick="finalizarCompra()">Finalizar Compra</button>
                </div>
            `;
            
            carrinhoItensContainer.innerHTML = html;
        });
        
        function alterarQuantidade(index, cambio) {
            const carrinhoItens = JSON.parse(localStorage.getItem('designfej_cart')) || [];
            
            if (carrinhoItens[index]) {
                carrinhoItens[index].quantity += cambio;
                
                // Remover item se quantidade for zero ou menos
                if (carrinhoItens[index].quantity <= 0) {
                    carrinhoItens.splice(index, 1);
                }
                
                localStorage.setItem('designfej_cart', JSON.stringify(carrinhoItens));
                location.reload(); // Recarregar p√°gina para atualizar
            }
        }
        
        function removerItem(index) {
            const carrinhoItens = JSON.parse(localStorage.getItem('designfej_cart')) || [];
            
            if (carrinhoItens[index]) {
                carrinhoItens.splice(index, 1);
                localStorage.setItem('designfej_cart', JSON.stringify(carrinhoItens));
                location.reload(); // Recarregar p√°gina para atualizar
            }
        }
        
        function aplicarCupom() {
            const codigo = document.getElementById('cupom-codigo').value.trim().toUpperCase();
            const resultado = document.getElementById('cupom-resultado');
            
            if (!codigo) {
                resultado.innerHTML = '<p style="color: red;">Digite um c√≥digo de cupom</p>';
                return;
            }
            
            // Verificar se cupom j√° foi aplicado
            const cupomAplicado = localStorage.getItem('cupom_aplicado');
            if (cupomAplicado) {
                resultado.innerHTML = '<p style="color: orange;">‚ö†Ô∏è J√° existe um cupom aplicado</p>';
                return;
            }
            
            // Criar cupom usando Decorator
            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('R$ ', '').replace(',', '.'));
            const cupomResult = criarCupomDecorator(codigo, subtotal);
            
            if (!cupomResult) {
                resultado.innerHTML = '<p style="color: red;">‚ùå Cupom inv√°lido</p>';
                return;
            }
            
            const totalFinal = cupomResult.valorFinal;
            const desconto = subtotal - totalFinal;
            
            // Atualizar interface
            document.getElementById('desconto-linha').style.display = 'flex';
            document.getElementById('desconto-valor').textContent = `- R$ ${desconto.toFixed(2)}`;
            document.getElementById('total-final').textContent = `R$ ${totalFinal.toFixed(2)}`;
            
            // Salvar cupom aplicado
            localStorage.setItem('cupom_aplicado', JSON.stringify({
                codigo: codigo,
                desconto: desconto,
                descricao: cupomResult.descricao
            }));
            
            resultado.innerHTML = `<p style="color: green;">‚úÖ ${cupomResult.descricao}</p>`;
            document.getElementById('cupom-codigo').disabled = true;
            document.getElementById('btn-aplicar').style.display = 'none';
            document.getElementById('btn-remover').style.display = 'inline-block';
        }
        
        function finalizarCompra() {
            const carrinhoItens = JSON.parse(localStorage.getItem('designfej_cart')) || [];
            
            if (carrinhoItens.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }
            
            // Redirecionar para p√°gina p√≥s-compra
            window.location.href = 'posCompra.html';
        }
        
        // Verificar se j√° existe cupom aplicado ao carregar a p√°gina
        function verificarCupomAplicado() {
            const cupomAplicado = localStorage.getItem('cupom_aplicado');
            if (cupomAplicado) {
                const cupom = JSON.parse(cupomAplicado);
                const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('R$ ', '').replace(',', '.'));
                const totalFinal = subtotal - cupom.desconto;
                
                document.getElementById('desconto-linha').style.display = 'flex';
                document.getElementById('desconto-valor').textContent = `- R$ ${cupom.desconto.toFixed(2)}`;
                document.getElementById('total-final').textContent = `R$ ${totalFinal.toFixed(2)}`;
                document.getElementById('cupom-codigo').value = cupom.codigo;
                document.getElementById('cupom-codigo').disabled = true;
                document.getElementById('cupom-resultado').innerHTML = `<p style="color: green;">‚úÖ Cupom ${cupom.codigo} aplicado!</p>`;
                document.getElementById('btn-aplicar').style.display = 'none';
                document.getElementById('btn-remover').style.display = 'inline-block';
            }
        }
        
        function removerCupom() {
            // Remover cupom do localStorage
            localStorage.removeItem('cupom_aplicado');
            
            // Recalcular total sem desconto
            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace('R$ ', '').replace(',', '.'));
            
            // Atualizar interface
            document.getElementById('desconto-linha').style.display = 'none';
            document.getElementById('total-final').textContent = `R$ ${subtotal.toFixed(2)}`;
            document.getElementById('cupom-codigo').value = '';
            document.getElementById('cupom-codigo').disabled = false;
            document.getElementById('cupom-resultado').innerHTML = '<p style="color: blue;">‚ÑπÔ∏è Cupom removido</p>';
            document.getElementById('btn-aplicar').style.display = 'inline-block';
            document.getElementById('btn-remover').style.display = 'none';
            
            // Limpar mensagem ap√≥s 3 segundos
            setTimeout(() => {
                document.getElementById('cupom-resultado').innerHTML = '';
            }, 3000);
        }
        
        // Chamar verifica√ß√£o ap√≥s carregar o carrinho
        setTimeout(verificarCupomAplicado, 100);
        
        function criarCupomDecorator(codigo, valor) {
            // Cupom base
            class CupomBase {
                constructor(codigo, descricao) {
                    this.codigo = codigo;
                    this.descricao = descricao;
                }
                aplicarDesconto(valor) { return valor; }
                getDescricao() { return this.descricao; }
            }
            
            // Decorator base
            class CupomDecorator extends CupomBase {
                constructor(cupom) {
                    super(cupom.codigo, cupom.descricao);
                    this.cupom = cupom;
                }
                aplicarDesconto(valor) { return this.cupom.aplicarDesconto(valor); }
                getDescricao() { return this.cupom.getDescricao(); }
            }
            
            // Decorators espec√≠ficos
            class DescontoPercentual extends CupomDecorator {
                constructor(cupom, percentual) {
                    super(cupom);
                    this.percentual = percentual;
                }
                aplicarDesconto(valor) {
                    const valorBase = super.aplicarDesconto(valor);
                    return valorBase - (valorBase * this.percentual / 100);
                }
                getDescricao() {
                    return `Cupom ${this.cupom.codigo}: ${this.percentual}% de desconto aplicado!`;
                }
            }
            
            class DescontoFixo extends CupomDecorator {
                constructor(cupom, valorDesconto) {
                    super(cupom);
                    this.valorDesconto = valorDesconto;
                }
                aplicarDesconto(valor) {
                    return Math.max(0, super.aplicarDesconto(valor) - this.valorDesconto);
                }
                getDescricao() {
                    return `Cupom ${this.cupom.codigo}: R$ ${this.valorDesconto.toFixed(2)} de desconto aplicado!`;
                }
            }
            
            class DescontoProgressivo extends CupomDecorator {
                constructor(cupom, percentual1, percentual2, valorMinimo) {
                    super(cupom);
                    this.percentual1 = percentual1;
                    this.percentual2 = percentual2;
                    this.valorMinimo = valorMinimo;
                }
                aplicarDesconto(valor) {
                    const valorBase = super.aplicarDesconto(valor);
                    const percentual = valorBase >= this.valorMinimo ? this.percentual2 : this.percentual1;
                    return valorBase - (valorBase * percentual / 100);
                }
                getDescricao() {
                    const percentual = valor >= this.valorMinimo ? this.percentual2 : this.percentual1;
                    return `Cupom ${this.cupom.codigo}: ${percentual}% de desconto aplicado!`;
                }
            }
            
            // Criar cupons com decorators
            const cupons = {
                'DESCONTO10': () => {
                    const base = new CupomBase('DESCONTO10', 'Desconto Fixo');
                    return new DescontoFixo(base, 10);
                },
                'FRETE20': () => {
                    const base = new CupomBase('FRETE20', 'Desconto Fixo');
                    return new DescontoFixo(base, 20);
                },
                'PRIMEIRA15': () => {
                    const base = new CupomBase('PRIMEIRA15', 'Desconto Percentual');
                    return new DescontoPercentual(base, 15);
                },
                'GLEISON60': () => {
                    const base = new CupomBase('GLEISON60', 'Desconto Especial');
                    return new DescontoPercentual(base, 60);
                },
                'PROGRESSIVO': () => {
                    const base = new CupomBase('PROGRESSIVO', 'Desconto Progressivo');
                    return new DescontoProgressivo(base, 10, 20, 200);
                }
            };
            
            if (!cupons[codigo]) {
                return null;
            }
            
            const cupom = cupons[codigo]();
            const valorFinal = cupom.aplicarDesconto(valor);
            
            return {
                valorFinal: valorFinal,
                descricao: cupom.getDescricao()
            };
        }
    </script>
    <script src="/js/sidebar.js"></script>
</body>
</html>