<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - DesignFej</title>
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/posCompra.css">
</head>
<body>
    <header>
        <div class="top-bar">
            <button onclick="window.location.href='index.html'" class="icon-btn">üè° Inicio</button>
            <h2>Finalizar Compra</h2>
        </div>
    </header>

    <main class="pos-compra-container">
        <div class="resumo-pedido">
            <h3>üì¶ Resumo do Pedido</h3>
            <div id="itens-pedido"></div>
            <div class="subtotal">
                <p>Subtotal: R$ <span id="subtotal">0,00</span></p>
            </div>
        </div>

        <div class="calculo-frete">
            <h3>üöö Frete</h3>
            <div class="frete-fixo">
                <p><strong>Frete fixo para todo o Brasil:</strong></p>
                <p class="frete-valor">R$ 15,90</p>
                <p class="frete-prazo">Prazo: 5-7 dias √∫teis</p>
            </div>
        </div>

        <div class="metodo-pagamento">
            <h3>üí≥ M√©todo de Pagamento</h3>
            <div class="pagamento-opcoes">
                <label class="opcao-pagamento">
                    <input type="radio" name="pagamento" value="credito" checked>
                    <span>üí≥ Cart√£o de Cr√©dito</span>
                </label>
                <label class="opcao-pagamento">
                    <input type="radio" name="pagamento" value="debito">
                    <span>üí≥ Cart√£o de D√©bito</span>
                </label>
            </div>
            
            <div class="dados-cartao">
                <div class="campo-grupo">
                    <label for="numero-cartao">N√∫mero do Cart√£o:</label>
                    <input type="text" id="numero-cartao" placeholder="0000 0000 0000 0000" maxlength="19">
                </div>
                <div class="campo-linha">
                    <div class="campo-grupo">
                        <label for="validade">Validade:</label>
                        <input type="text" id="validade" placeholder="MM/AA" maxlength="5">
                    </div>
                    <div class="campo-grupo">
                        <label for="cvv">CVV:</label>
                        <input type="text" id="cvv" placeholder="000" maxlength="3">
                    </div>
                </div>
                <div class="campo-grupo">
                    <label for="nome-cartao">Nome no Cart√£o:</label>
                    <input type="text" id="nome-cartao" placeholder="Nome como impresso no cart√£o">
                </div>
            </div>
        </div>

        <div class="total-final">
            <div class="total-box">
                <h3>üí∞ Total Final</h3>
                <p>Subtotal: R$ <span id="total-subtotal">0,00</span></p>
                <p>Frete: R$ <span id="total-frete">0,00</span></p>
                <hr>
                <p class="total-geral"><strong>Total: R$ <span id="total-geral">0,00</span></strong></p>
                <button onclick="confirmarPedido()" class="btn-confirmar">Confirmar Pedido</button>
            </div>
        </div>
    </main>

    <script>
        let dadosPedido = {
            itens: [],
            subtotal: 0,
            frete: 0,
            total: 0
        };

        document.addEventListener('DOMContentLoaded', function() {
            carregarItensPedido();
            aplicarFreteFixo();
            configurarCamposCartao();
        });

        function carregarItensPedido() {
            const cartItems = JSON.parse(localStorage.getItem('designfej_cart')) || [];
            const container = document.getElementById('itens-pedido');
            let subtotal = 0;

            if (cartItems.length === 0) {
                container.innerHTML = '<p>Nenhum item no carrinho</p>';
                return;
            }

            cartItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;

                container.innerHTML += `
                    <div class="item-pedido">
                        <img src="${item.image}" alt="${item.name}">
                        <div class="item-info">
                            <h4>${item.name}</h4>
                            <p>Quantidade: ${item.quantity}</p>
                            <p>Pre√ßo unit√°rio: R$ ${item.price.toFixed(2)}</p>
                            <p><strong>Total: R$ ${itemTotal.toFixed(2)}</strong></p>
                        </div>
                    </div>
                `;
            });

            dadosPedido.itens = cartItems;
            dadosPedido.subtotal = subtotal;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('total-subtotal').textContent = subtotal.toFixed(2);
            atualizarTotal();
        }

        function aplicarFreteFixo() {
            dadosPedido.frete = 15.90;
            atualizarTotal();
        }
        
        function configurarCamposCartao() {
            // Formatar n√∫mero do cart√£o
            document.getElementById('numero-cartao').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                e.target.value = value;
            });
            
            // Formatar validade
            document.getElementById('validade').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
            
            // Apenas n√∫meros no CVV
            document.getElementById('cvv').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        }

        function atualizarTotal() {
            const total = dadosPedido.subtotal + dadosPedido.frete;
            dadosPedido.total = total;
            
            document.getElementById('total-frete').textContent = dadosPedido.frete.toFixed(2);
            document.getElementById('total-geral').textContent = total.toFixed(2);
        }

        async function confirmarPedido() {
            if (!validarPagamento()) {
                return;
            }
            
            const metodoPagamento = document.querySelector('input[name="pagamento"]:checked').value;
            const nomeCartao = document.getElementById('nome-cartao').value;
            const tipoPagamento = `Cart√£o de ${metodoPagamento === 'credito' ? 'Cr√©dito' : 'D√©bito'}`;
            
            try {
                // Salvar pedido no banco de dados
                const response = await fetch('/api/compras/finalizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        itens: dadosPedido.itens.map(item => ({
                            produtoId: item.id,
                            quantidade: item.quantity
                        })),
                        nomeUsuario: nomeCartao,
                        tipoPagamento: tipoPagamento,
                        valorTotal: dadosPedido.total
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Criar pedido para localStorage (compatibilidade)
                    const pedido = {
                        id: result.numeroPedido.replace(/[#\s]/g, ''),
                        data: new Date().toISOString(),
                        itens: dadosPedido.itens,
                        subtotal: dadosPedido.subtotal,
                        frete: dadosPedido.frete,
                        total: dadosPedido.total,
                        status: 'Confirmado',
                        pagamento: tipoPagamento,
                        titular: nomeCartao,
                        codigoRastreamento: 'BR' + Math.random().toString().slice(2, 11)
                    };
                    
                    // Salvar no localStorage
                    const pedidos = JSON.parse(localStorage.getItem('designfej_pedidos')) || [];
                    pedidos.push(pedido);
                    localStorage.setItem('designfej_pedidos', JSON.stringify(pedidos));
                    
                    alert(`Pedido confirmado!\nN√∫mero: ${result.numeroPedido}\nTotal: R$ ${dadosPedido.total.toFixed(2)}\nFrete: R$ ${dadosPedido.frete.toFixed(2)}\nPagamento: ${tipoPagamento}\nTitular: ${nomeCartao}`);
                    
                    // Limpa carrinho
                    localStorage.removeItem('designfej_cart');
                    
                    // Redireciona para meus pedidos
                    setTimeout(() => {
                        window.location.href = 'meusPedidos.html';
                    }, 2000);
                } else {
                    alert('Erro ao confirmar pedido: ' + result.message);
                }
            } catch (error) {
                console.error('Erro ao confirmar pedido:', error);
                alert('Erro ao confirmar pedido. Tente novamente.');
            }
        }
        
        function validarPagamento() {
            const numeroCartao = document.getElementById('numero-cartao').value.replace(/\s/g, '');
            const validade = document.getElementById('validade').value;
            const cvv = document.getElementById('cvv').value;
            const nomeCartao = document.getElementById('nome-cartao').value.trim();
            
            if (numeroCartao.length !== 16) {
                alert('Por favor, digite um n√∫mero de cart√£o v√°lido (16 d√≠gitos)');
                return false;
            }
            
            if (validade.length !== 5 || !validade.includes('/')) {
                alert('Por favor, digite uma validade v√°lida (MM/AA)');
                return false;
            }
            
            if (cvv.length !== 3) {
                alert('Por favor, digite um CVV v√°lido (3 d√≠gitos)');
                return false;
            }
            
            if (nomeCartao.length < 2) {
                alert('Por favor, digite o nome do titular do cart√£o');
                return false;
            }
            
            return true;
        }
    </script>
</body>
</html>